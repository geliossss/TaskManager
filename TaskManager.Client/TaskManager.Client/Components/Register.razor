@page "/register"
@using TaskManager.Domain.Models
@using TaskManager.Data
@inject AppDbContext Db
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore

<h3>Регистрация</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <p style="color: red">@Message</p>
}

<div>
    <label>Фамилия:</label>
    <input @bind="LastName" />
</div>
<div>
    <label>Имя:</label>
    <input @bind="FirstName" />
</div>
<div>
    <label>Отчество:</label>
    <input @bind="SurName" />
</div>
<div>
    <label>Логин:</label>
    <input @bind="Login" />
</div>
<div>
    <label>Пароль:</label>
    <input type="password" @bind="Password" />
</div>

<button @onclick="RegisterUser">Зарегистрироваться</button>

@code {
    private string LastName { get; set; } = "";
    private string FirstName { get; set; } = "";
    private string SurName { get; set; } = "";
    private string Login { get; set; } = "";
    private string Password { get; set; } = "";
    private string? Message { get; set; }

    private async Task RegisterUser()
    {
        // Проверка на существующего пользователя
        var existing = await Db.Users.FirstOrDefaultAsync(u => u.Login == Login);
        if (existing != null)
        {
            Message = "Пользователь с таким логином уже существует.";
            return;
        }

        var user = new User
            {
                LastName = LastName,
                FirstName = FirstName,
                SurName = SurName,
                Login = Login,
                Password = Password
            };

        Db.Users.Add(user);
        await Db.SaveChangesAsync();

        // Переход на профиль
        Nav.NavigateTo("/profile");
    }
}
